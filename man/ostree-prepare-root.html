<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>ostree prepare-root</title><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="refentry"><a name="ostree"></a><div class="titlepage"></div><div class="refnamediv"><h2>Name</h2><p>ostree-prepare-root &#8212; Change the view of a mounted root filesystem to an ostree deployment</p></div><div class="refsynopsisdiv"><h2>Synopsis</h2><div class="cmdsynopsis"><p><code class="command">ostree prepare-root</code>  {TARGET}</p></div></div><div class="refsect1"><a name="id1337"></a><h2>Description</h2><p>
            At its core, ostree operates on an existing mounted filesystem.  Tooling such
            as <code class="literal">ostree admin deploy</code> will create a new directory that can be
            used as a bootable target.  This tool is designed to run in an initramfs and
            set up "remapping" mounts as a view into that filesystem.
        </p><p>
            As of more recently, this tool also has optional support for composefs, which
            creates a distinct mount point layered on top of the underlying filesystem.
        </p><p>
            The most common pattern today is to use systemd in an initramfs.  The systemd
            unit shipped upstream is ordered in this way:

            <code class="literal">After=sysroot.mount</code> and <code class="literal">Before=initrd-root-fs.target</code>
        </p><p>
            When it runs, the mounted filesystem at the provided <code class="literal">TARGET</code> (usually <code class="literal">/sysroot</code>)
            will be changed such that what appears at <code class="literal">/sysroot</code> is actually the
            "deployment root" - i.e. a particular versioned subdirectory.  What was formerly the
            "physical root" i.e. the real root of the filesystem will appear as <code class="literal">/sysroot/sysroot</code>.
        </p><p>
            For <code class="literal">/var</code>, by default a bind mount is created from the deployment root to <code class="literal">/sysroot/var</code>.
        </p><p>
            A read-only bind mount is created over <code class="literal">/sysroot/usr</code>.  The immutable bit is set on the deployment
            root, so this provides basic protection for filesystem mutation.  If the <code class="literal">sysroot.readonly</code>
            option is enabled, instead a writable bind mount for <code class="literal">/sysroot/etc</code>, and everything else
            is mounted read-only.
        </p><p>
            Finally, when higher level tooling such as systemd performs a switch-root operation, what
            was <code class="literal">/sysroot</code> becomes <code class="literal">/</code> and after the transition into
            the real root, the system will be booted into the "deployment", which is a versioned immutable
            filesystem tree.  The ostree tooling running in the real root thereafter performs further changes
            by operating on <code class="literal">/sysroot</code> which is now the "physical root".
        </p></div><div class="refsect1"><a name="id1338"></a><h2>systemd</h2><p>
            As mentioned above, this tool comes with a systemd unit file <code class="literal">ostree-prepare-root.service</code>
            and it is primarily expected to be invoked this way.
        </p></div><div class="refsect1"><a name="id1339"></a><h2>Composefs</h2><p>
            The default for ostree is to create a plain hardlinked filesystem tree.
            composefs support is currently experimental; see the upstream <code class="literal">doc/composefs.md</code>
            for more information on using it.
        </p></div></div></body></html>
